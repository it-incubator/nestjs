# Подробное объяснение

### version: '3.8'

Указывает версию файла Docker Compose, определяя доступные возможности и синтаксис.

---

### x-postgres-common

Используется для хранения общих настроек сервисов PostgreSQL, чтобы избежать дублирования кода.

- **&postgres-common**

  Создает якорь с именем `postgres-common` для последующего включения этих настроек в сервисы с помощью `<<: *postgres-common`.

- **image: postgres:14-alpine**

  Указывает образ Docker для запуска контейнера PostgreSQL версии 14 на базе легковесного Alpine Linux.

- **user: postgres**

  Определяет пользователя внутри контейнера, под которым будут выполняться процессы.

- **restart: always**

  Гарантирует автоматический перезапуск контейнера в случае его остановки или сбоя.

- **healthcheck**

  Настраивает проверку работоспособности контейнера.

    - **test: 'pg_isready -U user --dbname=postgres'**

      Команда, которая проверяет, доступен ли сервер PostgreSQL.

    - **interval**, **timeout**, **retries**

      Параметры, определяющие частоту и поведение проверки состояния.

---

## Сервисы (services):

### postgres_primary

Основной сервер PostgreSQL (мастер).

- **<<: *postgres-common**

  Включает все настройки из раздела `postgres-common`.

- **ports: - 5433:5432**

  Пробрасывает порт `5432` контейнера на порт `5433` хоста, позволяя подключаться к PostgreSQL с хоста через порт `5433`.

- **environment**

  Переменные окружения для настройки сервера.

    - **POSTGRES_USER**, **POSTGRES_DB**, **POSTGRES_PASSWORD**

      Стандартные переменные для установки пользователя, базы данных и пароля при инициализации PostgreSQL.

    - **POSTGRES_HOST_AUTH_METHOD**

      Определяет методы аутентификации для подключения и репликации.

        - **scram-sha-256**

          Безопасный метод хеширования паролей.

        - **host replication all 0.0.0.0/0 md5**

          Разрешает всем хостам подключаться для репликации с использованием MD5-аутентификации.

    - **POSTGRES_INITDB_ARGS**

      Дополнительные аргументы для команды инициализации базы данных.

- **command**

  Переопределяет команду запуска контейнера для настройки дополнительных параметров PostgreSQL.

    - **postgres**

      Запускает сервер PostgreSQL.

    - **-c**

      Позволяет устанавливать параметры конфигурации.

        - **wal_level=replica**

          Устанавливает уровень сохранения WAL (журнала предзаписи) для поддержки репликации.

        - **hot_standby=on**

          Включает режим горячего резерва, позволяющий реплике принимать запросы на чтение.

        - **max_wal_senders=10**

          Устанавливает максимальное число процессов отправки WAL.

        - **max_replication_slots=10**

          Устанавливает максимальное число слотов репликации.

        - **hot_standby_feedback=on**

          Предотвращает очистку необходимых реплике WAL-файлов на мастере.

- **volumes**

  Монтирует файлы или директории из хоста в контейнер.

    - **./init.sql:/docker-entrypoint-initdb.d/init.sql**

      Монтирует локальный файл `init.sql` в специальную директорию внутри контейнера, из которой PostgreSQL выполнит SQL-скрипты при инициализации.

---

### postgres_replica

Реплика сервера PostgreSQL.

- **<<: *postgres-common**

  Включает общие настройки.

- **ports: - 5434:5432**

  Пробрасывает порт `5432` контейнера на порт `5434` хоста.

- **environment**

    - **PGUSER**

      Пользователь для подключения к мастеру (репликатор).

    - **PGPASSWORD**

      Пароль для пользователя репликатора.

- **command**

  Использует bash для выполнения скрипта и запуска PostgreSQL.

    - **bash -c "..."**

      Запускает командную оболочку bash.

        - **if [ ! -s /var/lib/postgresql/data/PG_VERSION ]; then**

          Проверяет, существует ли файл `PG_VERSION` в директории данных. Если нет, то база данных не инициализирована.

            - **echo 'Initializing replica...'**

              Выводит сообщение о начале инициализации реплики.

            - **until pg_basebackup ...**

              Пытается создать базовый бэкап с мастера, повторяя попытки до успешного подключения.

                - **--pgdata=/var/lib/postgresql/data**

                  Указывает директорию для размещения данных.

                - **-R**

                  Создает файл `recovery.conf` для автоматической настройки репликации.

                - **--slot=replication_slot**

                  Использует указанный слот репликации на мастере.

                - **--host=postgres_primary --port=5432**

                  Подключается к мастеру по указанному хосту и порту.

            - **do ... done**

              Цикл, который повторяет попытки подключения к мастеру.

            - **echo 'Backup done, starting replica...'**

              Сообщает об успешном создании бэкапа.

        - **else ... fi**

          Если база данных уже инициализирована, просто запускаем сервер.

            - **echo 'Data directory exists, starting replica...'**

              Информирует о существовании данных и начале запуска.

        - **chmod 0700 /var/lib/postgresql/data**

          Устанавливает правильные права доступа на директорию данных.

        - **postgres**

          Запускает сервер PostgreSQL.

- **depends_on**

    - **postgres_primary**

      Указывает, что запуск реплики зависит от запуска мастера, обеспечивая правильный порядок запуска контейнеров.

---

Этот файл `docker-compose.yml` настроен таким образом, чтобы автоматизировать процесс создания и восстановления реплики PostgreSQL. Он включает механизмы для проверки состояния реплики и автоматического восстановления при перезапусках, что особенно полезно в средах, где реплика может часто перезагружаться.